version: 0.2

phases:
  install:
    commands:
      # Change directory to the project folder
      - cd vote
      # Install Python dependencies
      - pip install -r requirements.txt
      # Install Trivy for image scanning
      - curl -sSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
      - export PATH=$PATH:/root/.local/bin  # Add Trivy to the PATH
      # Install Bandit for static analysis
      - pip install bandit
      # Download SonarQube Scanner with corrected URL
      - curl -sSL https://binaries.sonarsource.com/Commercial/sonar-scanner-cli/sonar-scanner-4.6.2.2472-linux.zip -o sonar-scanner.zip
      - ls -lh sonar-scanner.zip  # Check if the file exists and its size
      - file sonar-scanner.zip     # Check the file type (should be ZIP)
      # If the file is a ZIP, unzip; otherwise, try to use tar
      - if [[ $(file sonar-scanner.zip) == *"Zip"* ]]; then unzip sonar-scanner.zip -d /opt/sonar-scanner; else echo "Error: Invalid file format"; exit 1; fi
      # If unzip fails, try using tar as a fallback (in case it's a tar.gz file)
      - if [ $? -ne 0 ]; then curl -sSL https://binaries.sonarsource.com/Commercial/sonar-scanner-cli/sonar-scanner-4.6.2.2472-linux.tar.gz -o sonar-scanner.tar.gz; fi
      - if [ -f sonar-scanner.tar.gz ]; then tar -xzf sonar-scanner.tar.gz -C /opt/sonar-scanner; fi
      - export PATH=$PATH:/opt/sonar-scanner/sonar-scanner-4.6.2.2472-linux/bin  # Add sonar-scanner to the PATH

  pre_build:
    commands:
      # Run Bandit for Python code security checks
      - bandit -r my_python_app

  build:
    commands:
      # Run Trivy for container/image security scan
      - trivy fs . --exit-code 1 --severity HIGH,CRITICAL
      # Run tests (e.g., using pytest)
      - pytest

  post_build:
    commands:
      # Run SonarQube scanner
      - sonar-scanner -Dsonar.projectKey=my-python-app -Dsonar.host.url=http://3.92.68.102:9000 -Dsonar.login=squ_01e57532fb456d834eb594cdc93209e0b1798ad1

artifacts:
  files:
    - '**/*'  # Save all files from the current directory
  discard-paths: yes
  base-directory: .  # Set base directory to the current directory

cache:
  paths:
    - '/root/.cache/pip/**/*'
